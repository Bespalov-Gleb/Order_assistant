{% extends "base.html" %}

{% block title %}–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ {{ order.order_number }} - Order Assistant{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ {{ order.order_number }}</h1>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
</div>

<div class="assembly-container">
    <div class="progress-info">
        <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∫–∏</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p class="progress-text"><span id="currentItem">0</span> –∏–∑ <span id="totalItems">{{ items|length }}</span></p>
    </div>

    <div class="current-item-card" id="currentItemCard">
        <div class="item-number" id="itemNumber">-</div>
        <div class="item-name" id="itemName">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å" –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Å–±–æ—Ä–∫–∏</div>
        <div class="item-quantity" id="itemQuantity"></div>
        <div class="item-status" id="itemStatus"></div>
    </div>

    <div class="voice-controls">
        <button class="btn btn-large btn-success" id="startBtn" onclick="startAssembly()">
            –ù–∞—á–∞—Ç—å —Å–±–æ—Ä–∫—É
        </button>
        
        <div id="activeControls" style="display: none;">
            <div class="voice-status" id="voiceStatus">
                <span class="mic-icon">üé§</span>
                <span id="statusText">–°–ª—É—à–∞—é –∫–æ–º–∞–Ω–¥—É...</span>
            </div>
            
            <div class="manual-controls">
                <button class="btn btn-large btn-success" onclick="markCompleted()">
                    ‚úì –ï—Å—Ç—å / –î–∞–ª—å—à–µ
                </button>
                <button class="btn btn-large btn-danger" onclick="markSkipped()">
                    ‚úó –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <div id="completeSection" style="display: none;">
        <div class="complete-card">
            <h2>–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</p>
            <button class="btn btn-large btn-primary" onclick="completeOrder('—Å–æ–±—Ä–∞–Ω')">
                –°–æ–±—Ä–∞–Ω
            </button>
            <button class="btn btn-large btn-secondary" onclick="completeOrder('–≤_–∞—Ä—Ö–∏–≤')">
                –í –∞—Ä—Ö–∏–≤
            </button>
        </div>
    </div>

    <div class="items-list">
        <h3>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <div id="itemsList">
            {% for item in items %}
            <div class="item-row item-status-{{ item.status }}" id="item-{{ item.id }}" data-item-id="{{ item.id }}">
                <span class="item-row-number">{{ item.row_number }}</span>
                <span class="item-row-name">{{ item.name }}</span>
                <span class="item-row-quantity">{{ item.quantity }} {{ item.unit }}</span>
                <span class="item-row-badge badge-{{ item.status }}"></span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö
const items = {{ items | tojson }};
const orderId = {{ order.id }};
let currentIndex = 0;
let recognition = null;
let isListening = false;
let audioPlayer = null;
let isAudioPlaying = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Speech API
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = true;
        recognition.interimResults = false;
        
        recognition.onresult = (event) => {
            const last = event.results.length - 1;
            const command = event.results[last][0].transcript.toLowerCase().trim();
            
            console.log('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:', command);
            document.getElementById('statusText').textContent = `–ö–æ–º–∞–Ω–¥–∞: "${command}"`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã
            if (command.includes('–µ—Å—Ç—å') || command.includes('–¥–∞–ª—å—à–µ') || command.includes('–¥–∞')) {
                markCompleted();
            } else if (command.includes('–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å') || command.includes('–ø—Ä–æ–ø—É—Å–∫') || command.includes('–Ω–µ—Ç')) {
                markSkipped();
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å "—Å–ª—É—à–∞—é"
            setTimeout(() => {
                if (isListening) {
                    document.getElementById('statusText').textContent = '–°–ª—É—à–∞—é –∫–æ–º–∞–Ω–¥—É...';
                }
            }, 1000);
        };
        
        recognition.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
            if (event.error === 'no-speech') {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É –æ—à–∏–±–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å
                return;
            }
            document.getElementById('statusText').textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è';
        };
        
        recognition.onend = () => {
            if (isListening && currentIndex < items.length) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition already started');
                }
            }
        };
    } else {
        alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏.');
    }
}

function startAssembly() {
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('activeControls').style.display = 'block';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
    if (!audioPlayer) {
        audioPlayer = new Audio();
        audioPlayer.addEventListener('ended', () => {
            isAudioPlaying = false;
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
    initSpeechRecognition();
    
    // –û–∑–≤—É—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ Silero (backend TTS)
    fetch(`/api/tts/order/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.audio_url) {
                playAudio(data.audio_url, () => {
                    showNextItem();
                });
            } else {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—É–¥–∏–æ, –ø—Ä–æ—Å—Ç–æ –∏–¥–µ–º –¥–∞–ª—å—à–µ
                showNextItem();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TTS –∑–∞–∫–∞–∑–∞:', error);
            showNextItem();
        });
}

function showNextItem() {
    if (currentIndex >= items.length) {
        finishAssembly();
        return;
    }
    
    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏–æ
    stopListening();
    stopAudio();
    
    const item = items[currentIndex];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
    document.getElementById('itemNumber').textContent = `‚Ññ ${item.row_number}`;
    document.getElementById('itemName').textContent = item.name;
    document.getElementById('itemQuantity').textContent = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity} ${item.unit}`;
    
    if (item.should_announce) {
        document.getElementById('itemStatus').textContent = '';
        
        // –ü–æ–ª—É—á–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º TTS –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ Silero
        fetch(`/api/tts/item/${item.id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.audio_url) {
                    playAudio(data.audio_url, () => {
                        // –ü–æ—Å–ª–µ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã
                        startListening();
                    });
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—É–¥–∏–æ, —Å—Ä–∞–∑—É —Å–ª—É—à–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
                    startListening();
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TTS —Ç–æ–≤–∞—Ä–∞:', error);
                startListening();
            });
    } else {
        document.getElementById('itemStatus').textContent = `‚ö†Ô∏è ${item.filtered_reason}`;
        document.getElementById('itemStatus').style.color = '#f39c12';
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        setTimeout(() => {
            markSkipped(true);
        }, 1500);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    updateProgress();
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä –≤ —Å–ø–∏—Å–∫–µ
    highlightCurrentItem();
}

function startListening() {
    if (recognition && !isListening) {
        isListening = true;
        try {
            recognition.start();
            document.getElementById('voiceStatus').style.display = 'block';
        } catch (e) {
            console.log('Recognition already started or error:', e);
        }
    }
}

function stopListening() {
    if (recognition && isListening) {
        isListening = false;
        recognition.stop();
        document.getElementById('voiceStatus').style.display = 'none';
    }
}

function markCompleted() {
    markItem('completed');
}

function markSkipped(auto = false) {
    markItem('skipped');
}

function markItem(status) {
    if (currentIndex >= items.length) return;
    
    const item = items[currentIndex];
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
    stopListening();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    fetch(`/api/order/${orderId}/item/${item.id}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            const itemRow = document.getElementById(`item-${item.id}`);
            itemRow.className = `item-row item-status-${status}`;
            itemRow.querySelector('.item-row-badge').className = `item-row-badge badge-${status}`;
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç–æ–≤–∞—Ä—É
            currentIndex++;
            setTimeout(() => {
                showNextItem();
            }, 500);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–≤–∞—Ä–∞');
    });
}

function updateProgress() {
    const progress = (currentIndex / items.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('currentItem').textContent = currentIndex;
    document.getElementById('totalItems').textContent = items.length;
}

function highlightCurrentItem() {
    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
    document.querySelectorAll('.item-row').forEach(row => {
        row.classList.remove('current-item');
    });
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
    if (currentIndex < items.length) {
        const item = items[currentIndex];
        const itemRow = document.getElementById(`item-${item.id}`);
        if (itemRow) {
            itemRow.classList.add('current-item');
            itemRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}

function finishAssembly() {
    stopListening();
    stopAudio();
    document.getElementById('currentItemCard').style.display = 'none';
    document.getElementById('activeControls').style.display = 'none';
    document.getElementById('completeSection').style.display = 'block';
}

function completeOrder(status) {
    fetch(`/api/order/${orderId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{{ url_for("index") }}';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
    });
}

function playAudio(url, onEnded) {
    if (!audioPlayer) {
        audioPlayer = new Audio();
    }
    
    try {
        isAudioPlaying = true;
        audioPlayer.src = url;
        audioPlayer.onended = () => {
            isAudioPlaying = false;
            if (typeof onEnded === 'function') {
                onEnded();
            }
        };
        audioPlayer.onerror = (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:', e);
            isAudioPlaying = false;
            if (typeof onEnded === 'function') {
                onEnded();
            }
        };
        audioPlayer.play().catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ:', err);
            isAudioPlaying = false;
            if (typeof onEnded === 'function') {
                onEnded();
            }
        });
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ playAudio:', e);
        isAudioPlaying = false;
        if (typeof onEnded === 'function') {
            onEnded();
        }
    }
}

function stopAudio() {
    if (audioPlayer && isAudioPlaying) {
        try {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        } catch (e) {
            console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞—É–¥–∏–æ:', e);
        }
        isAudioPlaying = false;
    }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    stopListening();
    stopAudio();
});
</script>
{% endblock %}



