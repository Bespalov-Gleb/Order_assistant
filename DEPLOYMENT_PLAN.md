# План развертывания Order Assistant на icesmoke.store

## Текущая ситуация:

- ✅ Есть веб-консоль (не SSH)
- ❓ Нужно проверить доступ к Nginx
- ✅ На домене уже работает онлайн магазин
- ❓ Нужно проверить возможность создания поддомена

---

## Варианты развертывания:

### Вариант 1: Поддомен `voice.icesmoke.store` (РЕКОМЕНДУЕТСЯ)

**Преимущества:**
- ✅ Не трогаем основной сайт
- ✅ Проще настроить через панель
- ✅ Изолирован от магазина

**Шаги:**
1. Создать поддомен через панель управления
2. Загрузить код в папку поддомена
3. Настроить приложение
4. Запустить через Gunicorn

**Проверка:** См. `CHECK_SUBDOMAIN.md`

---

### Вариант 2: Путь `/voice/` на основном домене

**Преимущества:**
- ✅ Не нужен поддомен
- ✅ Работает на том же домене

**Недостатки:**
- ⚠️ Нужно править конфигурацию Nginx (может сломать магазин)
- ⚠️ Нужен доступ к конфигурации

**Шаги:**
1. Проверить доступ к Nginx (см. `CHECK_NGINX_ACCESS.md`)
2. Найти конфигурацию `icesmoke.store`
3. Добавить блок `location /voice/` (ОСТОРОЖНО!)
4. Загрузить код в отдельную папку
5. Запустить через Gunicorn

---

## Пошаговый план действий:

### Шаг 1: Проверка возможностей

```bash
# Выполните в веб-консоли:

# 1. Проверка доступа к Nginx
ls -la /etc/nginx/ 2>/dev/null && echo "✅ Nginx доступен" || echo "❌ Nginx недоступен"

# 2. Проверка веб-сервера
ps aux | grep -E "nginx|apache" | grep -v grep

# 3. Проверка структуры www/
ls -la ~/www/

# 4. Проверка поддомена
dig voice.icesmoke.store +short
```

### Шаг 2: Выбор варианта

**Если можно создать поддомен** → Вариант 1 (поддомен)
**Если есть доступ к Nginx** → Вариант 2 (`/voice/`)
**Если ничего не работает** → Обратитесь в поддержку хостинга

### Шаг 3: Подготовка кода

1. Убедитесь, что в `.env` установлено:
   ```env
   APP_PREFIX=/voice  # для варианта 2
   # или
   APP_PREFIX=/  # для поддомена
   ```

2. Проверьте настройки Yandex TTS в `.env`

### Шаг 4: Загрузка на сервер

**Для поддомена:**
```bash
# Загрузить в папку поддомена (например, ~/www/voice/)
```

**Для /voice/:**
```bash
# Загрузить в отдельную папку (например, ~/order-assistant/)
```

### Шаг 5: Настройка на сервере

1. Создать виртуальное окружение:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   pip install gunicorn
   ```

2. Настроить `.env` файл

3. Инициализировать БД:
   ```bash
   python init_db.py
   ```

### Шаг 6: Запуск приложения

**Через screen/tmux (если нет systemd):**
```bash
screen -S order-assistant
cd /path/to/order-assistant
source venv/bin/activate
gunicorn --workers 3 --bind 127.0.0.1:5000 wsgi:app
# Ctrl+A, D для отсоединения
```

**Через systemd (если есть доступ):**
```bash
# Создать сервис (см. deploy_production.sh)
sudo systemctl enable order-assistant
sudo systemctl start order-assistant
```

### Шаг 7: Настройка веб-сервера

**Для поддомена:**
- Настроить через панель управления (указать папку и прокси на порт 5000)

**Для /voice/:**
- Добавить в конфигурацию Nginx (см. `nginx_config_example.conf`)
- Перезагрузить Nginx

---

## ⚠️ ВАЖНО: Не сломать магазин!

### При настройке `/voice/`:

1. **Сначала сделайте бэкап** конфигурации Nginx
2. **Тестируйте на тестовом домене** если возможно
3. **Проверьте**, что основной сайт работает после изменений

### При настройке поддомена:

1. Убедитесь, что поддомен не конфликтует с основным сайтом
2. Проверьте, что DNS записи настроены правильно

---

## Проверка после развертывания:

1. Откройте `voice.icesmoke.store` (или `icesmoke.store/voice/`)
2. Проверьте, что главная страница загружается
3. Попробуйте загрузить тестовый заказ
4. Проверьте, что TTS работает

---

## Если что-то пошло не так:

1. Проверьте логи:
   ```bash
   # Логи приложения
   tail -f ~/logs/order-assistant.log
   
   # Логи веб-сервера
   tail -f /var/log/nginx/error.log
   ```

2. Проверьте, что приложение запущено:
   ```bash
   ps aux | grep gunicorn
   ```

3. Проверьте порт:
   ```bash
   netstat -tlnp | grep 5000
   ```

